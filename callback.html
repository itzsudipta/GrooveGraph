<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Callback</title>
    <script>
        async function exchangeCodeForToken(code) {
            const clientId = 'c3c6f141c28441f9bdd0988863be0d92'; // Replace with your actual client ID
            const clientSecret = 'ff1254589c8846248f3b705c3a3c2251'; // Replace with your actual client secret
            const redirectUri = 'https://itzsudipta.github.io/GrooveGraph/callback.html';

            try {
                const tokenResponse = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret) // Base64 encoded client ID and secret
                    },
                    body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: redirectUri,
                        client_id: clientId
                    }).toString()
                });

                if (!tokenResponse.ok) {
                    const errorData = await tokenResponse.json();
                    throw new Error(errorData.error_description || 'Token exchange failed');
                }

                const tokens = await tokenResponse.json();
                sessionStorage.setItem('spotify_access_token', tokens.access_token);
                window.location.href = 'https://itzsudipta.github.io/GrooveGraph/'; // Redirect to your main page
            } catch (error) {
                console.error('Token exchange error:', error);
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);  // Changed to use query string params
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                console.error('Error during authentication:', error);
                document.getElementById('error-message').textContent = 'Authentication failed. Please try again.';
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }

            if (code) {
                // Call the function to exchange the code for a token
                exchangeCodeForToken(code);
            } else {
                console.error('No code found');
                document.getElementById('error-message').textContent = 'Authentication failed. Please try again.';
                document.getElementById('error-message').classList.remove('hidden');
            }
        });
    </script>
</head>

<body>
    <h1>Redirecting...</h1>
    <div id="error-message" class="hidden" style="color: red;"></div>
</body>

</html>