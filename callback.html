<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrooveGraph - Authentication</title>
    <script>
        if (!codeVerifier) {
                document.getElementById('error-message').textContent = 'Missing code verifier. Please restart login.';
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }

        async function exchangeCodeForToken(code) {
            const clientId = 'c3c6f141c28441f9bdd0988863be0d92'; // Your Spotify client ID
            const redirectUri = 'https://itzsudipta.github.io/GrooveGraph/callback.html'; // Callback URL
            const codeVerifier = sessionStorage.getItem('code_verifier'); // Code verifier for PKCE

            try {
                const response = await fetch('https://accounts.spotify.com/api/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        client_id: clientId,
                        grant_type: 'authorization_code',
                        code: code,
                        redirect_uri: redirectUri,
                        code_verifier: codeVerifier,
                    })
                });

                const data = await response.json();
                if (!response.ok) throw new Error(data.error_description);

                // Store the access token in session storage
                sessionStorage.setItem('spotify_access_token', data.access_token);
                sessionStorage.removeItem('code_verifier');

                // Redirect back to the main page (root of the app)
                window.location.href = redirectUri.replace('/callback.html', '/');
            } catch (error) {
                console.error('Token exchange failed:', error);
                document.getElementById('error-message').textContent = `Token exchange failed: ${error.message}`;
                document.getElementById('error-message').classList.remove('hidden');
            }
        }

        // Handle the callback URL parameters
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');
            const state = params.get('state');
            const storedState = sessionStorage.getItem('spotify_auth_state');

            // Handle errors
            if (error) {
                document.getElementById('error-message').textContent = `Authentication failed: ${error}`;
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }

            // State mismatch check
            if (state !== storedState) {
                document.getElementById('error-message').textContent = 'State mismatch. Please try again.';
                document.getElementById('error-message').classList.remove('hidden');
                return;
            }

            // Exchange the code for an access token if all checks are passed
            if (code) {
                sessionStorage.removeItem('spotify_auth_state'); // Clear state from session
                exchangeCodeForToken(code); // Call function to exchange the code
            }
        });
    </script>
</head>

<body>
    <div id="loading">Completing authentication...</div>
    <div id="error-message" class="hidden" style="color: red; font-size: 16px; padding: 10px;"></div>
</body>

</html>